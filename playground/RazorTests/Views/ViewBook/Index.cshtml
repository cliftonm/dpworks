@{
    var db = Database.Open("Books"); 
    
    var books = db.Query(@"SELECT b.BookId, b.Title, b.ISBN, b.AuthorId, b.CategoryId, 
                            a.FirstName + ' ' + a.LastName AS AuthorName, c.Category, b.Hardback  
                            FROM Books b INNER JOIN Authors a 
                            ON b.AuthorId = a.AuthorId  
                            INNER JOIN Categories c 
                            ON b.CategoryId = c.CategoryId 
                            ORDER BY b.BookId DESC");
                                                   
    var categories = db.Query("SELECT CategoryId, Category FROM Categories")
                        .Select(category => new SelectListItem {
                            Value = category.CategoryId.ToString(), 
                            Text = category.Category
                         }); 
                         
    var authors = db.Query("SELECT AuthorId, FirstName + ' ' + LastName AS AuthorName FROM Authors")
                        .Select(author => new SelectListItem {
                            Value = author.AuthorId.ToString(), 
                            Text = author.AuthorName
                         });   
                         
    var grid = new WebGrid(books);                                                         
}



<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Inline Editing with the WebGrid</title>
        <link rel="stylesheet" href="~/Styles/StyleSheet.css" type="text/css" />
        <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.1.min.js" type="text/javascript"></script>
        <script>
            $(function () {
                $('.edit-mode').hide();
                $('.edit-book').on('click', function () {
                    var tr = $(this).parents('tr:first');
                    tr.find('.edit-mode, .display-mode').toggle();
                });
                $('.save-book').on('click', function () {
                    var tr = $(this).parents('tr:first');
                    var bookId = $(this).prop('id');
                    var title = tr.find('#Title').val();
                    var authorId = tr.find('#AuthorId').val();
                    var categoryId = tr.find('#CategoryId').val();
                    var authorName = tr.find("#AuthorId option:selected").text();
                    var categoryName = tr.find("#CategoryId option:selected").text();
                    var isbn = tr.find('#ISBN').val();
                    var hardback = tr.find('#Hardback').attr('checked') ? true : false;

                    // Update the display mode line:
                    tr.find('#title').text(title);
                    tr.find('#authorname').text(authorName);
                    tr.find('#category').text(categoryName);
                    tr.find('#isbn').text(isbn);
                    tr.find('#hardback-display').removeAttr("disabled").attr('checked', hardback).attr('disabled', true);

                    // Post the data so the server saves it.
                    $.post(
                        '/ViewBook/SaveChanges',
                        { BookId: bookId, Title: title, AuthorId: authorId, CategoryId: categoryId, ISBN: isbn, Hardback: hardback });

                    // Revert to display mode.
                    tr.find('.edit-mode, .display-mode').toggle();
                });
            })
        </script>
    </head>
    <body>
        @grid.GetHtml(
            tableStyle : "table",
            alternatingRowStyle : "alternate",
            selectedRowStyle: "selected",
            headerStyle : "header", 
            columns : grid.Columns(
                grid.Column("", 
                            style: "col1", 
                            format: @<text>
                                        <button class="edit-book display-mode" id="@item.BookId">Edit</button>
                                        <button class="save-book edit-mode" id="@item.BookId">Save</button>
                                    </text>),
                grid.Column("Title",
                            style: "col2",
                            format: @<text>
                                        <span id="title" class="display-mode">@item.Title</span>
                                        @Html.TextBox("Title", (string)item.Title, new {@class="edit-mode", size = 45})
                                    </text>),
                grid.Column("AuthorName",
                            header : "Author",
                            style: "col3",
                            format: @<text>
                                        <span id="authorname" class="display-mode">@item.AuthorName</span>
                                        @Html.DropDownList("AuthorId", new SelectList(authors, "Value", "Text", @item.AuthorId), new {@class="edit-mode"})
                                    </text>),
                grid.Column("Category",
                            style: "col4",
                            format: @<text>
                                        <span id="category" class="display-mode">@item.Category</span>
                                        @Html.DropDownList("CategoryId", new SelectList(categories, "Value", "Text", @item.CategoryId), new {@class="edit-mode"})
                                    </text>),
                grid.Column("ISBN",
                            style: "col5",
                            format: @<text>
                                        <span id="isbn" class="display-mode">@item.ISBN</span>
                                        @Html.TextBox("ISBN", (string)item.ISBN, new {@class="edit-mode", size = 20})
                                    </text>),
                grid.Column("Hardback",
                            style: "col6",
                            format: @<text>
                                        <span class="display-mode">@Html.CheckBox("hardback-display", (bool)item.Hardback, new {disabled="disabled"})</span>
                                        @Html.CheckBox("Hardback", (bool)item.Hardback, new {@class="edit-mode"})
                                    </text>)
             )    
        )
    </body>
</html>


