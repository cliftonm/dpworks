<!DOCTYPE html>

@{
    var grid = (WebGrid)ViewBag.Grid;
    var authors = ViewBag.Authors;
    var categories = ViewBag.Categories;
}


<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Inline Editing with the WebGrid</title>
        <link rel="stylesheet" href="~/Styles/StyleSheet.css" type="text/css" />
        <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.1.min.js" type="text/javascript"></script>

        <script>
            function setArrows() {
                var dir = $('#dir').val();
                var col = $('#col').val();
                var header = $('th a[href*=' + col + ']');

                if (dir == 'Ascending') {
                    header.text(header.text() + ' ▲');
                }

                if (dir == 'Descending') {
                    header.text(header.text() + ' ▼');
                }

                $('.edit-mode').hide();
                $('.display-mode').show();
            };

            $(function () {
                $('.edit-mode').hide();
                // Use of .live is removed for jQuery 1.9 and beyond.
                $('.edit-book').live('click', function () {
                    var tr = $(this).parents('tr:first');
                    tr.find('.edit-mode, .display-mode').toggle();
                });
                $('.save-book').live('click', function () {
                    var tr = $(this).parents('tr:first');
                    var bookId = $(this).prop('id');
                    var title = tr.find('#Title').val();
                    var authorId = tr.find('#AuthorId').val();
                    var categoryId = tr.find('#CategoryId').val();
                    var authorName = tr.find("#AuthorId option:selected").text();
                    var categoryName = tr.find("#CategoryId option:selected").text();
                    var isbn = tr.find('#ISBN').val();
                    var hardback = tr.find('#Hardback').attr('checked') ? true : false;

                    // Update the display mode line:
                    tr.find('#title').text(title);
                    tr.find('#authorname').text(authorName);
                    tr.find('#category').text(categoryName);
                    tr.find('#isbn').text(isbn);
                    tr.find('#hardback-display').removeAttr("disabled").attr('checked', hardback).attr('disabled', true);

                    // Post the data so the server saves it.
                    $.post(
                        '/ViewBook/SaveChanges',
                        { BookId: bookId, Title: title, AuthorId: authorId, CategoryId: categoryId, ISBN: isbn, Hardback: hardback });

                    // Revert to display mode.
                    tr.find('.edit-mode, .display-mode').toggle();
                });
            })
        </script>
    </head>

    <body>
        <div id="grid">
            @grid.GetHtml(
                tableStyle : "table",
                alternatingRowStyle : "alternate",
                selectedRowStyle: "selected",
                headerStyle : "header", 
                columns : grid.Columns(
                    grid.Column("", 
                                style: "col1", 
                                format: @<text>
                                            <button class="edit-book display-mode" id="@item.BookId">Edit</button>
                                            <button class="save-book edit-mode" id="@item.BookId">Save</button>
                                        </text>),
                    grid.Column("Title",
                                style: "col2",
                                format: @<text>
                                            <span id="title" class="display-mode">@item.Title</span>
                                            @Html.TextBox("Title", (string)item.Title, new {@class="edit-mode", size = 45})
                                        </text>),
                    grid.Column("AuthorName",
                                header : "Author",
                                style: "col3",
                                format: @<text>
                                            <span id="authorname" class="display-mode">@item.AuthorName</span>
                                            @Html.DropDownList("AuthorId", new SelectList(authors, "Value", "Text", @item.AuthorId), new {@class="edit-mode"})
                                        </text>),
                    grid.Column("Category",
                                style: "col4",
                                format: @<text>
                                            <span id="category" class="display-mode">@item.Category</span>
                                            @Html.DropDownList("CategoryId", new SelectList(categories, "Value", "Text", @item.CategoryId), new {@class="edit-mode"})
                                        </text>),
                    grid.Column("ISBN",
                                style: "col5",
                                format: @<text>
                                            <span id="isbn" class="display-mode">@item.ISBN</span>
                                            @Html.TextBox("ISBN", (string)item.ISBN, new {@class="edit-mode", size = 20})
                                        </text>),
                    grid.Column("Hardback",
                                style: "col6",
                                format: @<text>
                                            <span class="display-mode">@Html.CheckBox("hardback-display", (bool)item.Hardback, new {disabled="disabled"})</span>
                                            @Html.CheckBox("Hardback", (bool)item.Hardback, new {@class="edit-mode"})
                                        </text>)
                 ) 
            )
        
            @Html.Hidden("dir", grid.SortDirection) 
            @Html.Hidden("col", grid.SortColumn)
        </div>
    </body>

</html>


